<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>ACE Realty CRM v3 ‚Äî Professional</title>
<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#0f172a" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="ACE Realty" />
<link rel="icon" href="ace-logo-192.png" />
<style>
:root{
  --primary:#0f172a; --accent:#0ea5e9; --bg:#f3f4f6; --card:#fff;
  --muted:#6b7280; --danger:#ef4444; --success:#16a34a; --glass:rgba(255,255,255,0.6);
  --shadow:0 6px 30px rgba(15,23,42,0.06);
  --radius:14px;
  --glass-border: 1px solid rgba(14,165,233,0.08);
}
*{box-sizing:border-box}
html{overscroll-behavior:none}
body{
  margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
  background:var(--bg);color:var(--primary);-webkit-font-smoothing:antialiased;
  padding-top:env(safe-area-inset-top);padding-bottom:calc(78px + env(safe-area-inset-bottom));
  -webkit-user-select:none;user-select:none;
}

/* Header */
.header{
  position:sticky;top:0;z-index:120;background:linear-gradient(135deg,#021028,var(--primary));
  color:#fff;padding:16px 18px;padding-top:calc(16px + env(safe-area-inset-top));
  display:flex;align-items:center;justify-content:space-between;box-shadow:0 6px 24px rgba(2,6,23,0.35);
}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:44px;height:44px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--primary);font-size:18px}
.header h1{font-size:18px;margin:0;font-weight:700}
.header p{font-size:12px;margin:0;opacity:0.9}

/* Sync btn */
.sync-btn{
  background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08);
  color:#e8f6ff;padding:8px 12px;border-radius:999px;display:flex;gap:8px;align-items:center;
  cursor:pointer;font-size:13px;
}
.sync-dot{width:9px;height:9px;border-radius:99px;background:#ef4444;box-shadow:0 0 0 4px rgba(239,68,68,0.06)}
.sync-dot.ok{background:#16a34a;box-shadow:0 0 0 6px rgba(22,163,74,0.06)}

/* Bottom nav */
.bottom-nav{
  position:fixed;left:0;right:0;bottom:0;background:var(--card);display:flex;justify-content:space-around;padding:10px 6px;
  box-shadow:0 -6px 30px rgba(2,6,23,0.06);z-index:140;border-top-left-radius:14px;border-top-right-radius:14px;
}
.nav-btn{background:transparent;border:none;display:flex;flex-direction:column;align-items:center;color:#8892a6;font-size:12px;padding:6px 8px;cursor:pointer}
.nav-btn .icon{font-size:18px;margin-bottom:4px}
.nav-btn.active{color:var(--accent)}

/* Pages */
.page{display:none;padding:16px}
.page.active{display:block}

/* Cards */
.card{
  background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);margin-bottom:14px;
}
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:14px}
.stat{padding:12px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfdff);display:flex;flex-direction:column;gap:6px}
.stat h3{margin:0;font-size:20px}
.stat p{margin:0;font-size:11px;color:var(--muted);text-transform:uppercase}

/* Quick actions */
.quick-actions{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px}
.quick{background:var(--card);border-radius:12px;padding:12px;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;box-shadow:var(--shadow)}
.quick .icon{font-size:20px}

/* Search and filters */
.search-box input{width:100%;padding:12px;border-radius:12px;border:1px solid #e8eef6;background:#fbfdff}
.filter-row{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
.filter{padding:8px 12px;border-radius:999px;background:#fff;border:1px solid #eef4fb;color:var(--muted);cursor:pointer}
.filter.active{background:linear-gradient(90deg,#e6f8ff,#f2fcff);color:var(--primary);border-color:rgba(14,165,233,0.12);font-weight:600}

/* Property list */
.property-card{display:flex;gap:14px;border-radius:12px;overflow:hidden;cursor:pointer}
.property-image{width:140px;height:100px;background:linear-gradient(135deg,#eef2f6,#fff);display:flex;align-items:center;justify-content:center;overflow:hidden}
.property-image img{width:100%;height:100%;object-fit:cover}
.property-info{padding:12px;flex:1}
.property-title{font-weight:700;margin-bottom:4px}
.property-meta{font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
.owner{background:#fbfdff;border-left:3px solid var(--accent);padding:8px;border-radius:8px;font-size:13px;margin-top:8px}

/* Modal & view */
.modal{position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(2,6,23,0.45);display:none;align-items:flex-end;z-index:200}
.modal.show{display:flex}
.modal-box{width:100%;max-height:90vh;background:var(--card);border-radius:18px 18px 0 0;overflow:auto}
.modal-header{background:linear-gradient(135deg,#021028,var(--primary));color:#fff;padding:14px;display:flex;justify-content:space-between;align-items:center}
.modal-body{padding:16px}
.modal-footer{padding:12px;border-top:1px solid #f1f6fb;background:#fbfdff;display:flex;gap:8px;padding-bottom:calc(12px + env(safe-area-inset-bottom))}

/* Forms */
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.form-group{margin-bottom:12px}
.form-group label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
.form-group input, .form-group textarea, .form-group select{
  width:100%;padding:10px;border-radius:10px;border:1px solid #eef4fb;background:#fff;font-size:14px;
}
.form-group textarea{min-height:110px;resize:vertical}

/* image preview */
.image-preview{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
.preview{position:relative;border-radius:10px;overflow:hidden}
.preview img{width:100%;height:100%;object-fit:cover}
.preview button{position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.6);color:#fff;border:none;border-radius:99px;width:28px;height:28px;cursor:pointer}

/* Splash */
.splash{position:fixed;left:0;top:0;right:0;bottom:0;background:radial-gradient(circle at top,#0ea5e9,#021028);display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;z-index:9999}
.splash .icon{width:88px;height:88px;border-radius:18px;background:rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:26px;margin-bottom:12px}
.splash.hide{opacity:0;pointer-events:none;transition:opacity .35s}

/* small */
.btn{padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
.btn-primary{background:var(--primary);color:#fff}
.btn-outline{background:transparent;border:1px solid #e6f4ff;color:var(--primary)}
.btn-danger{background:var(--danger);color:#fff}

/* confirmation modal */
.confirm-box{background:var(--card);padding:18px;border-radius:14px;box-shadow:var(--shadow);text-align:center;max-width:420px;margin:auto}
.small-note{font-size:12px;color:var(--muted);margin-top:6px}
.footer-note{font-size:12px;color:var(--muted);text-align:center;margin-top:16px}
</style>
</head>
<body>

<!-- Splash -->
<div class="splash" id="splash">
  <div class="icon">ACE</div>
  <div style="font-weight:800;font-size:20px">ACE Realty CRM</div>
  <div style="opacity:0.95;margin-top:6px">Professional Edition ‚Ä¢ v3</div>
</div>

<!-- Header -->
<header class="header">
  <div class="logo">
    <div class="logo-icon">ACE</div>
    <div>
      <h1>ACE Realty</h1>
      <p id="officeLabel">North Goa ‚Ä¢ Professional</p>
    </div>
  </div>
  <div style="display:flex;gap:10px;align-items:center">
    <button class="sync-btn" id="syncBtn" title="Sync to Google Sheets" onclick="handleSyncClick()">
      <div class="sync-dot" id="syncDot"></div>
      <div style="display:flex;flex-direction:column;align-items:flex-start">
        <span style="font-size:13px">Sync</span>
        <small id="syncStatus" style="font-size:10px;opacity:0.9">Cloud: not connected</small>
      </div>
    </button>
  </div>
</header>

<!-- Pages -->
<main>
  <!-- Home -->
  <section id="homePage" class="page active">
    <div class="stats-grid">
      <div class="stat card"><h3 id="cntProp">0</h3><p>Properties</p></div>
      <div class="stat card"><h3 id="cntLead">0</h3><p>Leads</p></div>
      <div class="stat card"><h3 id="cntHot">0</h3><p>Hot Leads</p></div>
      <div class="stat card"><h3 id="cntTask">0</h3><p>Tasks Today</p></div>
    </div>

    <div class="quick-actions">
      <div class="quick" onclick="openPropModal()"><div class="icon">üè†</div><div>Add Property</div></div>
      <div class="quick" onclick="openLeadModal()"><div class="icon">üë•</div><div>Add Lead</div></div>
      <div class="quick" onclick="openTaskModal()"><div class="icon">üìã</div><div>Add Task</div></div>
      <div class="quick" onclick="goPage('share')"><div class="icon">üì§</div><div>Share</div></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Today's Tasks</strong>
        <small id="todayCount" style="color:var(--muted)"></small>
      </div>
      <div id="todayList" style="margin-top:12px"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Recent Leads</strong>
        <small style="color:var(--muted)">Latest 5</small>
      </div>
      <div id="recentLeads" style="margin-top:12px"></div>
    </div>
  </section>

  <!-- Properties -->
  <section id="propertiesPage" class="page">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>Properties</strong>
          <div class="small-note">Manage listings ‚Äî grouped & filterable</div>
        </div>
        <div>
          <button class="btn btn-outline" onclick="openPropModal()">+ Add</button>
        </div>
      </div>

      <div style="Margin-top:12px">
        <div class="search-box"><input id="propSearch" placeholder="üîç Search title, location, owner..." oninput="renderProps()" /></div>
        <div class="filter-row" id="propFilters" style="margin-top:8px">
          <div class="filter active" data-type="">All</div>
          <div class="filter" data-type="plot">üå≥ Plot</div>
          <div class="filter" data-type="villa">üè° Villa</div>
          <div class="filter" data-type="apartment">üè¢ Apartment</div>
          <div class="filter" data-type="rental">üîë Rental</div>
        </div>
      </div>
    </div>

    <div id="propListContainer" style="margin-top:12px"></div>
  </section>

  <!-- Leads -->
  <section id="leadsPage" class="page">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Leads</strong><div class="small-note">Group by interested property type</div></div>
        <div><button class="btn btn-outline" onclick="openLeadModal()">+ Add</button></div>
      </div>

      <div style="margin-top:12px">
        <div class="search-box"><input id="leadSearch" placeholder="üîç Search name, phone, from..." oninput="renderLeads()" /></div>

        <!-- TYPE filters -->
        <div class="filter-row" id="leadFilters" style="margin-top:8px">
          <div class="filter active" data-type="">All</div>
          <div class="filter" data-type="plot">üå≥ Plot</div>
          <div class="filter" data-type="villa">üè° Villa</div>
          <div class="filter" data-type="apartment">üè¢ Apartment</div>
          <div class="filter" data-type="rental">üîë Rental</div>
        </div>

        <!-- STATUS filters (NEW) -->
        <div class="filter-row" id="leadStatusFilters" style="margin-top:10px">
          <div class="filter active" data-status="">All statuses</div>
          <div class="filter" data-status="new">üü¶ New</div>
          <div class="filter" data-status="contacted">üü© Contacted</div>
          <div class="filter" data-status="interested">üü® Interested</div>
          <div class="filter" data-status="closed">‚ö™ Closed</div>
        </div>

      </div>
    </div>

    <div id="leadListContainer" style="margin-top:12px"></div>
  </section>

  <!-- Tasks -->
  <section id="tasksPage" class="page">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Tasks</strong><div class="small-note">Filter by type & status</div></div>
        <div><button class="btn btn-outline" onclick="openTaskModal()">+ Add</button></div>
      </div>

      <div style="margin-top:12px">
        <div class="search-box"><input id="taskSearch" placeholder="üîç Search title or notes..." oninput="renderTasks()" /></div>
        <div class="filter-row" id="taskFilters" style="margin-top:8px">
          <div class="filter active" data-type="">All</div>
          <div class="filter" data-type="site-visit">üè† Site Visit</div>
          <div class="filter" data-type="follow-up">üìû Follow-up</div>
          <div class="filter" data-type="meeting">ü§ù Meeting</div>
          <div class="filter" data-type="call">üì± Call</div>
        </div>
      </div>
    </div>

    <div id="taskListContainer" style="margin-top:12px"></div>
  </section>

  <!-- Share -->
  <section id="sharePage" class="page">
    <div class="card">
      <strong>Share Properties</strong>
      <div class="small-note">Select properties and share description via WhatsApp</div>

      <div id="shareList" style="margin-top:12px"></div>
      <div style="margin-top:12px;display:flex;gap:10px">
        <button class="btn btn-primary" onclick="shareSelected()">üì± Share Selected</button>
        <button class="btn btn-outline" onclick="selectAllShare(true)">Select All</button>
        <button class="btn btn-outline" onclick="selectAllShare(false)">Clear</button>
      </div>
    </div>
  </section>

  <!-- Settings -->
  <section id="settingsPage" class="page">
    <div class="card">
      <strong>Cloud Backup & Admin</strong>
      <div class="small-note">Store & load data from Google Sheets (Apps Script)</div>

      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <div style="flex:1">
          <input id="gUrlInput" placeholder="Paste Google Script URL (admin only)" style="width:100%;padding:10px;border-radius:8px;border:1px solid #eef4fb" />
          <div style="font-size:12px;color:var(--muted);margin-top:6px">Stored URL is hidden for safety. Use admin button to set/change</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn btn-primary" onclick="adminSetUrl()">üîí Admin Set</button>
          <button class="btn btn-outline" onclick="showCloudOptions()">‚òÅÔ∏è Cloud</button>
        </div>
      </div>

      <div style="margin-top:14px;display:flex;gap:8px">
        <button class="btn btn-outline" onclick="exportBackup()">üì§ Export</button>
        <button class="btn btn-outline" onclick="document.getElementById('importFile').click()">üì• Import</button>
        <input id="importFile" type="file" accept=".json" style="display:none" onchange="importBackup(event)" />
        <button class="btn btn-danger" onclick="askClearAll()">üóë Clear All</button>
      </div>

      <div class="footer-note" style="margin-top:12px" id="cloudStatusNote">Cloud: not connected</div>
    </div>
  </section>

</main>

<!-- Bottom nav -->
<nav class="bottom-nav">
  <button class="nav-btn active" data-page="home" onclick="goPage('home')"><div class="icon">üè†</div><div>Home</div></button>
  <button class="nav-btn" data-page="properties" onclick="goPage('properties')"><div class="icon">üèòÔ∏è</div><div>Properties</div></button>
  <button class="nav-btn" data-page="leads" onclick="goPage('leads')"><div class="icon">üë•</div><div>Leads</div></button>
  <button class="nav-btn" data-page="tasks" onclick="goPage('tasks')"><div class="icon">üìã</div><div>Tasks</div></button>
  <button class="nav-btn" data-page="settings" onclick="goPage('settings')"><div class="icon">‚öôÔ∏è</div><div>Settings</div></button>
</nav>

<!-- FAB normal add -->
<button style="position:fixed;right:18px;bottom:92px;background:linear-gradient(90deg,var(--accent),#0bb0ff);border:none;color:var(--primary);width:56px;height:56px;border-radius:99px;font-size:22px;box-shadow:0 10px 30px rgba(2,6,23,0.15);z-index:150" onclick="addQuick()">
  Ôºã
</button>

<!-- View modal (properties/leads/tasks) -->
<div class="modal" id="viewModal">
  <div class="modal-box" role="dialog" aria-modal="true">
    <div class="modal-header">
      <div id="viewTitle">View</div>
      <div><button class="btn btn-outline" onclick="closeView()">Close</button></div>
    </div>
    <div class="modal-body" id="viewBody"></div>
  </div>
</div>

<!-- Add/Edit Property Modal -->
<div class="modal" id="propModal">
  <div class="modal-box">
    <div class="modal-header"><div id="propModalTitle">Add Property</div><div><button class="btn btn-outline" onclick="closePropModal()">Close</button></div></div>
    <div class="modal-body">
      <input type="hidden" id="propId" />
      <div class="form-row">
        <div class="form-group">
          <label>Type *</label>
          <select id="propType"><option value="">Select</option><option value="plot">Plot</option><option value="villa">Villa</option><option value="apartment">Apartment</option><option value="rental">Rental</option></select>
        </div>
        <div class="form-group">
          <label>Subtype (rental) / Zoning (plot)</label>
          <select id="propSubtype"><option value="">‚Äî</option><option value="residential">Residential</option><option value="commercial">Commercial</option></select>
        </div>
      </div>

      <div class="form-group"><label>Title *</label><input id="propTitle" /></div>
      <div class="form-group"><label>Location *</label><input id="propLoc" placeholder="e.g., Candolim, Goa" /></div>

      <div class="form-row" id="fieldsRow1">
        <div class="form-group"><label>Price *</label><input id="propPrice" placeholder="e.g., 3.5 Cr" /></div>
        <div class="form-group"><label>Area (total)</label><input id="propArea" placeholder="e.g., 2000 sqft / 186 sqm" /></div>
      </div>

      <!-- Plot-specific -->
      <div id="plotExtras" style="display:none">
        <div class="form-row">
          <div class="form-group"><label>Area of plot</label><input id="plotArea" placeholder="sqmt / sqft" /></div>
          <div class="form-group"><label>Price / sqmt</label><input id="plotPricePer" placeholder="e.g., 15000" /></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Zoning</label><input id="plotZoning" placeholder="e.g., Residential, Agricultural" /></div>
          <div class="form-group"><label>Legal Title</label><input id="plotTitle" placeholder="e.g., Freehold / Leasehold" /></div>
        </div>
      </div>

      <!-- Apartment/Villa extras -->
      <div id="aptVillaExtras" style="display:none">
        <div class="form-row">
          <div class="form-group"><label>Carpet Area</label><input id="carpetArea" placeholder="e.g., 850 sqft" /></div>
          <div class="form-group"><label>Built-up Area</label><input id="builtArea" placeholder="e.g., 1000 sqft" /></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Super Built-up</label><input id="superArea" placeholder="e.g., 1100 sqft" /></div>
          <div class="form-group"><label>Bedrooms</label><input id="propBeds" type="number" min="0" /></div>
        </div>
      </div>

      <!-- Rental extras -->
      <div id="rentalExtras" style="display:none">
        <div class="form-row">
          <div class="form-group"><label>Rental Type</label><select id="rentalType"><option value="">Select</option><option value="residential">Residential</option><option value="commercial">Commercial</option></select></div>
          <div class="form-group"><label>Deposit / Rent</label><input id="rentalPrice" placeholder="e.g., 50k / month" /></div>
        </div>
      </div>

      <div class="form-group">
        <label>Google Maps Link (optional)</label>
        <input id="propGeo" placeholder="Paste share link from Google Maps" />
        <div class="small-note">Share ‚Üí Copy link ‚Üí paste here. Will be included when sharing.</div>
      </div>

      <div class="form-group">
        <label>Photos</label>
        <div style="display:flex;gap:8px;align-items:center">
          <div style="flex:1">
            <div style="padding:8px;border-radius:10px;border:1px dashed #e6f4ff;background:#fbfdff;cursor:pointer" onclick="document.getElementById('propPhotos').click()">
              üì∑ Click to add photos
            </div>
            <input id="propPhotos" type="file" accept="image/*" multiple style="display:none" onchange="handlePropPhotos(event)" />
            <div class="image-preview" id="propPhotosPreview"></div>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>Share Description *</label>
        <textarea id="propDesc" placeholder="Write the WhatsApp share text that will be used when sharing..."></textarea>
        <div class="small-note">This text will be used directly for sharing. Include price, key points and contact.</div>
      </div>

      <div style="border-top:1px dashed #eef4fb;padding-top:12px;margin-top:12px">
        <div class="form-row">
          <div class="form-group"><label>Owner Name *</label><input id="propOwner" /></div>
          <div class="form-group"><label>Owner Phone *</label><input id="propOwnerPhone" /></div>
        </div>
        <div class="form-group"><label>Owner Notes (private)</label><textarea id="propOwnerNotes"></textarea></div>
      </div>

    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closePropModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveProperty()">Save Property</button>
    </div>
  </div>
</div>

<!-- Lead Modal -->
<div class="modal" id="leadModal">
  <div class="modal-box">
    <div class="modal-header"><div id="leadModalTitle">Add Lead</div><div><button class="btn btn-outline" onclick="closeLeadModal()">Close</button></div></div>
    <div class="modal-body">
      <input id="leadId" type="hidden" />
      <div class="form-row">
        <div class="form-group"><label>Name *</label><input id="leadName" /></div>
        <div class="form-group"><label>Phone *</label><input id="leadPhone" /></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Client From</label><input id="leadFrom" placeholder="City / State / Country" /></div>
        <div class="form-group"><label>Email</label><input id="leadEmail" /></div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Interested In *</label>
          <select id="leadType"><option value="">Select</option><option value="plot">Plot</option><option value="villa">Villa</option><option value="apartment">Apartment</option><option value="rental">Rental</option></select>
        </div>
        <div class="form-group"><label>Status</label><select id="leadStatus"><option value="new">New</option><option value="contacted">Contacted</option><option value="interested">Interested</option><option value="closed">Closed</option></select></div>
      </div>

      <div class="form-row">
        <div class="form-group"><label>Budget Min</label><input id="leadMin" /></div>
        <div class="form-group"><label>Budget Max</label><input id="leadMax" /></div>
      </div>

      <div class="form-group"><label>Preferred Location</label><input id="leadPrefLoc" /></div>
      <div class="form-group"><label>Notes</label><textarea id="leadNotes"></textarea></div>

    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeLeadModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveLead()">Save Lead</button>
    </div>
  </div>
</div>

<!-- Task Modal -->
<div class="modal" id="taskModal">
  <div class="modal-box">
    <div class="modal-header"><div id="taskModalTitle">Add Task</div><div><button class="btn btn-outline" onclick="closeTaskModal()">Close</button></div></div>
    <div class="modal-body">
      <input id="taskId" type="hidden" />
      <div class="form-group"><label>Title *</label><input id="taskTitle" /></div>
      <div class="form-row">
        <div class="form-group"><label>Type *</label><select id="taskType"><option value="">Select</option><option value="site-visit">Site Visit</option><option value="follow-up">Follow-up</option><option value="meeting">Meeting</option><option value="call">Call</option><option value="other">Other</option></select></div>
        <div class="form-group"><label>Date *</label><input id="taskDate" type="date" /></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Time</label><input id="taskTime" type="time" /></div>
        <div class="form-group"><label>Related Lead / Property ID</label><input id="taskRelated" placeholder="optional" /></div>
      </div>
      <div class="form-group"><label>Notes</label><textarea id="taskNotes"></textarea></div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeTaskModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveTask()">Save Task</button>
    </div>
  </div>
</div>

<!-- Confirm modal for back/close -->
<div class="modal" id="confirmModal">
  <div class="modal-box">
    <div class="modal-body">
      <div class="confirm-box" id="confirmBox">
        <div id="confirmText" style="font-weight:700"></div>
        <div class="small-note" id="confirmSub"></div>
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:center">
          <button class="btn btn-outline" onclick="closeConfirm()">Stay</button>
          <button class="btn btn-danger" id="confirmActionBtn">Exit</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------------------------
  ACE CRM v3 ‚Äî single-file (updated)
  Changes in this version:
  - Leads: new status filter row (All / New / Contacted / Interested / Closed)
  - Leads & Tasks: "View" action shows full details in view modal (not only edit)
  - Leads & Tasks: added Delete buttons where missing
  Minimal comments ‚Äî only why-critical lines.
*/

const ADMIN_PASS = 'ace@123'; // change as needed
const LS_PROPS = 'ace_p_v3';
const LS_LEADS = 'ace_l_v3';
const LS_TASKS = 'ace_t_v3';
const LS_URL = 'ace_g_v3';

let props = JSON.parse(localStorage.getItem(LS_PROPS) || '[]');
let leads = JSON.parse(localStorage.getItem(LS_LEADS) || '[]');
let tasks = JSON.parse(localStorage.getItem(LS_TASKS) || '[]');
let cloudUrl = localStorage.getItem(LS_URL) || '';
let stagedPhotos = [];

function saveAll(){
  localStorage.setItem(LS_PROPS, JSON.stringify(props));
  localStorage.setItem(LS_LEADS, JSON.stringify(leads));
  localStorage.setItem(LS_TASKS, JSON.stringify(tasks));
}
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
function el(id){ return document.getElementById(id); }
function qAll(sel){ return Array.from(document.querySelectorAll(sel)); }

window.addEventListener('load', ()=> {
  setTimeout(()=> el('splash').classList.add('hide'), 700);
  initApp();
});

function initApp(){
  wireFilters();
  refreshUI();
  renderCloudState();
  try{ el('taskDate').valueAsDate = new Date(); }catch(e){}
  history.pushState({page:'crm-root'}, '', location.href);
  window.addEventListener('popstate', onBackPressed);
  window.addEventListener('beforeunload', (e)=>{ e.preventDefault(); e.returnValue=''; });
}

let lastBackTime = 0;
function onBackPressed(evt){
  showConfirm('Leave app?', 'Press Stay to remain in CRM or Exit to close the app.', ()=>{ window.removeEventListener('popstate', onBackPressed); history.back(); setTimeout(()=> history.back(), 200); }, 'Exit');
}
function showConfirm(title, sub, cb, confirmText='Confirm'){
  el('confirmText').innerText = title;
  el('confirmSub').innerText = sub;
  el('confirmActionBtn').innerText = confirmText;
  el('confirmActionBtn').onclick = ()=> { closeConfirm(); cb(); };
  el('confirmModal').classList.add('show');
}
function closeConfirm(){ el('confirmModal').classList.remove('show'); }

function goPage(page){
  ['home','properties','leads','tasks','share','settings'].forEach(p=> { const s = el(p + 'Page'); if(s) s.classList.remove('active'); });
  el(page + 'Page').classList.add('active');
  qAll('.nav-btn').forEach(b=> b.classList.remove('active'));
  qAll('.nav-btn').forEach(b=> { if (b.dataset.page === page) b.classList.add('active'); });
  if (page === 'properties') renderProps();
  if (page === 'leads') renderLeads();
  if (page === 'tasks') renderTasks();
  if (page === 'share') renderShare();
}

function addQuick(){
  const page = document.querySelector('.nav-btn.active')?.dataset.page || 'home';
  if (page === 'leads') openLeadModal();
  else if (page === 'tasks') openTaskModal();
  else openPropModal();
}

/* ---------- Properties (no functional change) ---------- */
function openPropModal(editId){
  stagedPhotos = [];
  el('propPhotosPreview').innerHTML = '';
  el('propId').value = '';
  el('propModalTitle').innerText = editId ? 'Edit Property' : 'Add Property';
  ['propType','propSubtype','propTitle','propLoc','propPrice','propArea','plotArea','plotPricePer','plotZoning','plotTitle','carpetArea','builtArea','superArea','propBeds','rentalType','rentalPrice','propGeo','propDesc','propOwner','propOwnerPhone','propOwnerNotes'].forEach(id=>{ if (el(id)) el(id).value = ''; });
  togglePropertyExtras();
  if (editId){
    const p = props.find(x => x.id === editId);
    if (p){
      el('propId').value = p.id; el('propType').value = p.type || ''; el('propSubtype').value = p.subtype || ''; el('propTitle').value = p.title || ''; el('propLoc').value = p.loc || '';
      el('propPrice').value = p.price || ''; el('propArea').value = p.area || ''; el('plotArea').value = p.plotArea || ''; el('plotPricePer').value = p.plotPricePer || '';
      el('plotZoning').value = p.plotZoning || ''; el('plotTitle').value = p.plotTitle || ''; el('carpetArea').value = p.carpetArea || ''; el('builtArea').value = p.builtArea || '';
      el('superArea').value = p.superArea || ''; el('propBeds').value = p.beds || ''; el('rentalType').value = p.rentalType || ''; el('rentalPrice').value = p.rentalPrice || '';
      el('propGeo').value = p.geo || ''; el('propDesc').value = p.desc || ''; el('propOwner').value = p.oName || ''; el('propOwnerPhone').value = p.oPhone || ''; el('propOwnerNotes').value = p.oNotes || '';
      stagedPhotos = p.photos ? p.photos.slice() : []; renderPhotoPreviews(); togglePropertyExtras();
    }
  }
  el('propModal').classList.add('show');
}
function closePropModal(){ el('propModal').classList.remove('show'); }
function handlePropPhotos(evt){
  const files = Array.from(evt.target.files || []);
  files.forEach(file => {
    const fr = new FileReader();
    fr.onload = function(e){
      const img = new Image();
      img.onload = function(){
        const max = 1000;
        let w = img.width, h = img.height;
        if (w > h && w > max){ h = h * (max / w); w = max; }
        else if (h > max){ w = w * (max / h); h = max; }
        const c = document.createElement('canvas'); c.width = w; c.height = h;
        c.getContext('2d').drawImage(img,0,0,w,h);
        const data = c.toDataURL('image/jpeg', 0.7);
        stagedPhotos.push(data); renderPhotoPreviews();
      };
      img.src = e.target.result;
    };
    fr.readAsDataURL(file);
  });
}
function renderPhotoPreviews(){ const container = el('propPhotosPreview'); container.innerHTML = ''; stagedPhotos.forEach((d, idx) => { const div = document.createElement('div'); div.className = 'preview'; div.innerHTML = `<img src="${d}" /><button onclick="removeStagedPhoto(${idx})">‚úï</button>`; container.appendChild(div); }); }
function removeStagedPhoto(i){ stagedPhotos.splice(i,1); renderPhotoPreviews(); }
function togglePropertyExtras(){ const type = el('propType').value; el('plotExtras').style.display = (type === 'plot') ? 'block' : 'none'; el('aptVillaExtras').style.display = (type === 'apartment' || type === 'villa') ? 'block' : 'none'; el('rentalExtras').style.display = (type === 'rental') ? 'block' : 'none'; }
function saveProperty(){
  const id = el('propId').value || uid();
  const type = el('propType').value; const title = el('propTitle').value.trim(); const loc = el('propLoc').value.trim();
  const price = el('propPrice').value.trim(); const oName = el('propOwner').value.trim(); const oPhone = el('propOwnerPhone').value.trim(); const desc = el('propDesc').value.trim();
  if (!type || !title || !loc || !price || !oName || !oPhone || !desc){ alert('Please fill required fields (Type, Title, Location, Price, Owner name & phone, Description).'); return; }
  const p = { id, type, subtype: el('propSubtype').value || '', title, loc, price, area: el('propArea').value || '', plotArea: el('plotArea').value || '', plotPricePer: el('plotPricePer').value || '', plotZoning: el('plotZoning').value || '', plotTitle: el('plotTitle').value || '', carpetArea: el('carpetArea').value || '', builtArea: el('builtArea').value || '', superArea: el('superArea').value || '', beds: el('propBeds').value || '', rentalType: el('rentalType').value || '', rentalPrice: el('rentalPrice').value || '', geo: el('propGeo').value || '', desc, photos: stagedPhotos.slice(), oName, oPhone, oNotes: el('propOwnerNotes').value || '', created: new Date().toISOString() };
  const idx = props.findIndex(x=> x.id === id); if (idx >= 0) props[idx] = p; else props.push(p);
  saveAll(); closePropModal(); refreshUI(); alert('Property saved.');
}

/* ---------- Leads: render + view + delete + status filter ---------- */
let leadFilter = '';
let leadStatusFilter = '';

function openLeadModal(id){
  el('leadId').value = ''; el('leadModalTitle').innerText = id ? 'Edit Lead' : 'Add Lead';
  ['leadName','leadPhone','leadFrom','leadEmail','leadType','leadStatus','leadMin','leadMax','leadPrefLoc','leadNotes'].forEach(k=> el(k).value = '');
  if (id){
    const L = leads.find(x=> x.id === id);
    if (L){
      el('leadId').value = L.id; el('leadName').value = L.name || ''; el('leadPhone').value = L.phone || ''; el('leadFrom').value = L.from || ''; el('leadEmail').value = L.email || '';
      el('leadType').value = L.type || ''; el('leadStatus').value = L.status || 'new'; el('leadMin').value = L.min || ''; el('leadMax').value = L.max || ''; el('leadPrefLoc').value = L.loc || ''; el('leadNotes').value = L.notes || '';
    }
  }
  el('leadModal').classList.add('show');
}
function closeLeadModal(){ el('leadModal').classList.remove('show'); }

function saveLead(){
  const id = el('leadId').value || uid();
  const name = el('leadName').value.trim(); const phone = el('leadPhone').value.trim();
  const type = el('leadType').value;
  if (!name || !phone || !type) { alert('Please fill required fields: Name, Phone, Interested In.'); return; }
  const L = { id, name, phone, from: el('leadFrom').value || '', email: el('leadEmail').value || '', type, status: el('leadStatus').value || 'new', min: el('leadMin').value || '', max: el('leadMax').value || '', loc: el('leadPrefLoc').value || '', notes: el('leadNotes').value || '', created: new Date().toISOString() };
  const idx = leads.findIndex(x=> x.id === id); if (idx >= 0) leads[idx] = L; else leads.push(L);
  saveAll(); closeLeadModal(); refreshUI(); alert('Lead saved.');
}

/* New: viewLead (show full details in view modal) */
function viewLead(id){
  const L = leads.find(x => x.id === id); if (!L) return alert('Lead not found');
  el('viewTitle').innerText = L.name || 'Lead';
  let html = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong style="font-size:18px">${escapeHtml(L.name)}</strong><div class="small-note">${escapeHtml(L.type || '')} ‚Ä¢ ${escapeHtml(L.status || '')}</div></div></div>`;
  html += `<div style="margin-top:10px"><div class="small-note">üìû ${escapeHtml(L.phone || '-')}${L.email ? ' ‚Ä¢ ‚úâÔ∏è ' + escapeHtml(L.email) : ''}</div>`;
  if (L.from) html += `<div class="small-note">From: ${escapeHtml(L.from)}</div>`;
  if (L.min || L.max) html += `<div style="margin-top:8px" class="small-note">Budget: ${escapeHtml(L.min || '')}${L.max ? ' - ' + escapeHtml(L.max) : ''}</div>`;
  if (L.loc) html += `<div style="margin-top:8px" class="small-note">Preferred: ${escapeHtml(L.loc)}</div>`;
  if (L.notes) html += `<div style="margin-top:10px"><strong>Notes</strong><div class="small-note" style="white-space:pre-wrap">${escapeHtml(L.notes)}</div></div>`;
  html += `<div style="margin-top:12px;display:flex;gap:8px"><button class="btn btn-primary" onclick="callLead('${escapeHtml(L.phone)}')">üìû Call</button><button class="btn btn-outline" onclick="waLead('${escapeHtml(L.phone)}','${encodeURIComponent(L.name || '')}')">üí¨ WhatsApp</button><button class="btn btn-outline" onclick="editLead('${L.id}')">‚úèÔ∏è Edit</button><button class="btn btn-danger" onclick="deleteLead('${L.id}')">üóë Delete</button></div>`;
  el('viewBody').innerHTML = html; el('viewModal').classList.add('show');
}

/* editLead used earlier */
function editLead(id){ closeView(); openLeadModal(id); }

/* deleteLead (exposed) */
function deleteLead(id){
  if (!confirm('Delete lead?')) return;
  leads = leads.filter(l=> l.id !== id);
  saveAll(); refreshUI(); closeView();
}

/* helper to call and WA from view (pre-filled) */
function callLead(phone){ if (!phone) return alert('No phone'); location.href = `tel:${phone}`; }
function waLead(phoneOrEmpty, nameEncoded){
  const text = nameEncoded ? `Hi ${decodeURIComponent(nameEncoded)}` : 'Hi';
  window.open(`https://wa.me/${phoneOrEmpty ? phoneOrEmpty.replace(/\D/g,'') : ''}?text=${encodeURIComponent(text)}`, '_blank');
}

/* renderLeads updated to respect both type and status filters and include view/delete actions */
function renderLeads(){
  const container = el('leadListContainer');
  const search = (el('leadSearch').value || '').toLowerCase();
  const activeType = document.querySelector('#leadFilters .filter.active');
  leadFilter = activeType ? activeType.dataset.type : '';
  const activeStatus = document.querySelector('#leadStatusFilters .filter.active');
  leadStatusFilter = activeStatus ? (activeStatus.dataset.status || '') : '';

  let list = leads.filter(L=>{
    if (leadFilter && leadFilter !== '' && L.type !== leadFilter) return false;
    if (leadStatusFilter && leadStatusFilter !== '' && L.status !== leadStatusFilter) return false;
    if (!search) return true;
    return (L.name||'').toLowerCase().includes(search) || (L.phone||'').includes(search) || (L.from||'').toLowerCase().includes(search);
  });
  if (list.length === 0){ container.innerHTML = `<div class="card small-note">No leads found.</div>`; return; }
  const groups = {};
  list.forEach(l => (groups[l.type] = groups[l.type] || []).push(l));
  let html = '';
  ['plot','villa','apartment','rental'].forEach(type=>{
    if (!groups[type] || groups[type].length === 0) return;
    const label = ({plot:'üå≥ Plot',villa:'üè° Villa',apartment:'üè¢ Apartment',rental:'üîë Rental'})[type] || type;
    html += `<div class="card"><strong>${label} (${groups[type].length})</strong><div style="margin-top:10px">`;
    groups[type].sort((a,b)=> b.created.localeCompare(a.created)).forEach(l=>{
      html += `<div style="padding:10px;border-radius:10px;border:1px solid #f1f6fb;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
        <div style="flex:1">
          <div style="font-weight:700">${escapeHtml(l.name)}</div>
          <div class="small-note">${escapeHtml(l.phone)} ${l.from?(' ‚Ä¢ ' + escapeHtml(l.from)):''}</div>
          <div class="small-note">${l.min || ''}${l.max ? ' - ' + l.max : ''}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button class="btn btn-primary" onclick="viewLead('${l.id}')">View</button>
          <button class="btn btn-outline" onclick="editLead('${l.id}')">‚úèÔ∏è</button>
          <button class="btn btn-danger" onclick="deleteLead('${l.id}')">üóëÔ∏è</button>
        </div>
      </div>`;
    });
    html += '</div></div>';
  });
  container.innerHTML = html;
}

/* ---------- Tasks: view + delete ---------- */
function openTaskModal(id){
  ['taskId','taskTitle','taskType','taskDate','taskTime','taskRelated','taskNotes'].forEach(k=> el(k).value = '');
  if (id){
    const t = tasks.find(x=> x.id === id);
    if (t){ el('taskId').value = t.id; el('taskTitle').value = t.title; el('taskType').value = t.type; el('taskDate').value = t.date; el('taskTime').value = t.time || ''; el('taskRelated').value = t.related || ''; el('taskNotes').value = t.notes || ''; }
  } else {
    try{ el('taskDate').valueAsDate = new Date(); }catch(e){}
  }
  el('taskModal').classList.add('show');
}
function closeTaskModal(){ el('taskModal').classList.remove('show'); }

function saveTask(){
  const id = el('taskId').value || uid();
  const title = el('taskTitle').value.trim(); const type = el('taskType').value; const date = el('taskDate').value;
  if (!title || !type || !date) { alert('Please fill required fields: Title, Type, Date.'); return; }
  const t = { id, title, type, date, time: el('taskTime').value || '', related: el('taskRelated').value || '', notes: el('taskNotes').value || '', done: false, created: new Date().toISOString() };
  const idx = tasks.findIndex(x=> x.id === id); if (idx >= 0) tasks[idx] = t; else tasks.push(t);
  saveAll(); closeTaskModal(); refreshUI(); alert('Task saved.');
}
function toggleTaskDone(id){ const t = tasks.find(x=> x.id === id); if (!t) return; t.done = !t.done; saveAll(); refreshUI(); }
function deleteTask(id){ if (!confirm('Delete task?')) return; tasks = tasks.filter(x=> x.id !== id); saveAll(); refreshUI(); closeView(); }

/* New: viewTask shows full details in modal */
function viewTask(id){
  const t = tasks.find(x=> x.id === id); if (!t) return alert('Task not found');
  el('viewTitle').innerText = t.title || 'Task';
  let html = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong style="font-size:18px">${escapeHtml(t.title)}</strong><div class="small-note">${escapeHtml(t.type || '')} ‚Ä¢ ${escapeHtml(t.date || '')} ${t.time ? ' ‚Ä¢ ' + escapeHtml(t.time) : ''}</div></div></div>`;
  if (t.related) html += `<div style="margin-top:8px" class="small-note">Related: ${escapeHtml(t.related)}</div>`;
  if (t.notes) html += `<div style="margin-top:10px"><strong>Notes</strong><div class="small-note" style="white-space:pre-wrap">${escapeHtml(t.notes)}</div></div>`;
  html += `<div style="margin-top:12px;display:flex;gap:8px"><button class="btn btn-primary" onclick="toggleTaskDone('${t.id}')">${t.done ? 'Undo' : 'Mark Done'}</button><button class="btn btn-outline" onclick="openTaskModal('${t.id}')">‚úèÔ∏è Edit</button><button class="btn btn-danger" onclick="deleteTask('${t.id}')">üóë Delete</button></div>`;
  el('viewBody').innerHTML = html; el('viewModal').classList.add('show');
}

/* renderTasks: include View & Delete buttons */
let taskFilter = '';
function renderTasks(){
  const container = el('taskListContainer'); const search = (el('taskSearch').value || '').toLowerCase();
  const active = document.querySelector('#taskFilters .filter.active'); taskFilter = active ? active.dataset.type : '';
  let list = tasks.filter(t=> { if (taskFilter && taskFilter !== '' && t.type !== taskFilter) return false; if (!search) return true; return (t.title||'').toLowerCase().includes(search) || (t.notes||'').toLowerCase().includes(search); });
  if (list.length === 0){ container.innerHTML = `<div class="card small-note">No tasks yet.</div>`; return; }
  list.sort((a,b)=> a.date.localeCompare(b.date));
  let html = '';
  list.forEach(t=> {
    html += `<div class="card" style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-weight:700">${escapeHtml(t.title)} ${t.done ? ' ‚úÖ' : ''}</div>
        <div class="small-note">${t.type} ‚Ä¢ ${t.date} ${t.time ? ' ‚Ä¢ ' + t.time : ''}</div>
        ${t.notes ? `<div style="margin-top:6px">${escapeHtml(t.notes)}</div>` : ''}
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn btn-primary" onclick="viewTask('${t.id}')">View</button>
        <button class="btn btn-outline" onclick="openTaskModal('${t.id}')">‚úèÔ∏è</button>
        <button class="btn btn-danger" onclick="deleteTask('${t.id}')">üóëÔ∏è</button>
      </div>
    </div>`;
  });
  container.innerHTML = html;
}

/* ---------- Share + Settings + Cloud (no functional change) ---------- */
function renderShare(){ const c = el('shareList'); if (!c) return; if (props.length === 0) { c.innerHTML = `<div class="small-note">No properties to share.</div>`; return; } let html = ''; props.forEach(p=>{ const ok = p.desc && p.desc.trim().length > 6; html += `<div style="display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;border:1px solid #f1f6fb;margin-bottom:8px"><input type="checkbox" data-id="${p.id}" ${ok ? '' : 'disabled'} /><div style="flex:1"><div style="font-weight:700">${escapeHtml(p.title)}</div><div class="small-note">${escapeHtml(p.price || '')}</div></div><div><button class="btn btn-outline" onclick="shareProp('${p.id}')">üì§</button></div></div>`; }); c.innerHTML = html; }
function selectAllShare(val){ qAll('#shareList input[type="checkbox"]').forEach(cb => cb.checked = !!val); }
function shareSelected(){ const cbs = qAll('#shareList input[type="checkbox"]:checked'); if (!cbs.length) return alert('Select at least one property to share.'); const texts = []; cbs.forEach(cb => { const p = props.find(x => x.id === cb.dataset.id); if (p && p.desc) texts.push(p.desc + (p.geo ? `\n\nüìç Location: ${p.geo}` : '') + `\n\nContact: ${p.oName} ‚Ä¢ ${p.oPhone}`); }); const joined = texts.join('\n\n-----\n\n'); window.open(`https://wa.me/?text=${encodeURIComponent(joined)}`, '_blank'); }

function renderCloudState(){
  const dot = el('syncDot');
  if (cloudUrl){ el('syncStatus').innerText = 'Cloud: connected'; el('cloudStatusNote').innerText = 'Cloud: connected (URL hidden).'; dot.classList.add('ok'); if (el('gUrlInput')) el('gUrlInput').value = '(hidden) ‚Äî configured'; }
  else { el('syncStatus').innerText = 'Cloud: not connected'; el('cloudStatusNote').innerText = 'Cloud: not connected'; dot.classList.remove('ok'); if (el('gUrlInput')) el('gUrlInput').value = ''; }
}

function adminSetUrl(){ const pwd = prompt('Enter admin password:'); if (pwd !== ADMIN_PASS) { alert('Wrong password'); return; } const u = prompt('Paste Google Script web app URL (must be accessible):', cloudUrl || ''); if (!u) return; cloudUrl = u.trim(); localStorage.setItem(LS_URL, cloudUrl); renderCloudState(); alert('Cloud URL saved (hidden).'); }

function showCloudOptions(){ if (!cloudUrl){ if (!confirm('Cloud URL not set. Do you want to set it now (admin)?')) return adminSetUrl(); return; } const opt = prompt('Type "sync" to send data to Sheet, or "load" to pull data from Sheet (merge/overwrite). Type cancel to exit.', 'sync'); if (!opt) return; if (opt.toLowerCase() === 'sync') doSync(); else if (opt.toLowerCase() === 'load') loadFromCloud(); else alert('Unknown option'); }

function doSync(){ if (!cloudUrl) return alert('Cloud URL not configured. Set in Settings (admin).'); if (!confirm('Send local data (properties, leads, tasks) to cloud now?')) return; const payload = { action: 'sync', props, leads, tasks, timestamp: new Date().toISOString() }; fetch(cloudUrl, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) }).then(r=>{ alert('Sync request sent. Verify your sheet.'); }).catch(e=>{ console.error(e); alert('Sync failed. Check URL and internet. See console for error.'); }); }

function loadFromCloud(){ if (!cloudUrl) return alert('Cloud URL not configured.'); const pwd = prompt('Admin password required to load from cloud:'); if (pwd !== ADMIN_PASS) return alert('Wrong password.'); if (!confirm('Load data from cloud. You will be asked to Merge or Overwrite local data. Continue?')) return; const loadUrl = cloudUrl + (cloudUrl.indexOf('?') === -1 ? '?' : '&') + 'action=load'; fetch(loadUrl, { method:'GET', headers:{'Accept':'application/json'} }).then(r => r.json()).then(data => { if (!data) return alert('No data returned from cloud.'); const remoteProps = Array.isArray(data.props) ? data.props : []; const remoteLeads = Array.isArray(data.leads) ? data.leads : []; const remoteTasks = Array.isArray(data.tasks) ? data.tasks : []; const choice = prompt(`Cloud has ${remoteProps.length} properties, ${remoteLeads.length} leads, ${remoteTasks.length} tasks. Type "merge" or "overwrite"`); if (!choice) return; if (choice.toLowerCase() === 'overwrite'){ props = remoteProps; leads = remoteLeads; tasks = remoteTasks; saveAll(); refreshUI(); alert('Local data overwritten with cloud data.'); } else if (choice.toLowerCase() === 'merge'){ const mapP = {}; props.forEach(p=> mapP[p.id] = p); remoteProps.forEach(p=> { if (!mapP[p.id]) mapP[p.id] = p; }); props = Object.values(mapP); const mapL = {}; leads.forEach(l=> mapL[l.id] = l); remoteLeads.forEach(l=> { if (!mapL[l.id]) mapL[l.id] = l; }); leads = Object.values(mapL); const mapT = {}; tasks.forEach(t=> mapT[t.id] = t); remoteTasks.forEach(t=> { if (!mapT[t.id]) mapT[t.id] = t; }); tasks = Object.values(mapT); saveAll(); refreshUI(); alert('Merge complete.'); } else { alert('Unknown option; aborted.'); } }).catch(err=>{ console.error(err); alert('Failed to load from cloud. Ensure your Apps Script returns JSON and enables CORS. Check console.'); }); }

function handleSyncClick(){ if (!cloudUrl) { if (confirm('Cloud not configured. Set now (admin)?')) adminSetUrl(); return; } const action = prompt('Type "sync" to send local data, "load" to pull cloud data, or "status" to see cloud URL hint', 'sync'); if (!action) return; if (action.toLowerCase() === 'sync') doSync(); else if (action.toLowerCase() === 'load') loadFromCloud(); else if (action.toLowerCase() === 'status') alert(`Cloud: configured (hidden). To change, use Admin Set (requires password).`); }

/* ---------- Export / Import / Clear ---------- */
function exportBackup(){ const data = { props, leads, tasks, exported: new Date().toISOString() }; const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ACE_CRM_Backup_' + new Date().toISOString().slice(0,10) + '.json'; a.click(); }
function importBackup(evt){ const f = evt.target.files[0]; if (!f) return; const fr = new FileReader(); fr.onload = function(e){ try{ const data = JSON.parse(e.target.result); if (Array.isArray(data.props)) props = data.props; if (Array.isArray(data.leads)) leads = data.leads; if (Array.isArray(data.tasks)) tasks = data.tasks; saveAll(); refreshUI(); alert('Import complete'); }catch(err){ alert('Failed to read file'); } }; fr.readAsText(f); }
function askClearAll(){ const pwd = prompt('Admin password to clear all local data:'); if (pwd !== ADMIN_PASS) return alert('Wrong password'); if (!confirm('This will permanently delete all local data on this device. Continue?')) return; props = []; leads = []; tasks = []; saveAll(); refreshUI(); alert('Local data cleared.'); }

/* ---------- Helpers & UI ---------- */
function refreshUI(){
  el('cntProp').innerText = props.length;
  el('cntLead').innerText = leads.length;
  el('cntHot').innerText = leads.filter(l=> l.status === 'interested').length;
  const today = new Date().toISOString().split('T')[0];
  el('cntTask').innerText = tasks.filter(t => t.date === today && !t.done).length;
  renderTodayTasks(); renderRecentLeads(); renderProps(); renderLeads(); renderTasks(); renderShare(); renderCloudState();
}
function renderTodayTasks(){ const today = new Date().toISOString().split('T')[0]; const todays = tasks.filter(t => t.date === today && !t.done); const container = el('todayList'); if (!todays.length){ container.innerHTML = `<div class="small-note">No tasks today</div>`; return; } container.innerHTML = todays.map(t=> `<div style="display:flex;justify-content:space-between;padding:8px;border-radius:8px;border:1px solid #f1f6fb;margin-bottom:6px"><div><strong>${escapeHtml(t.title)}</strong><div class="small-note">${escapeHtml(t.time || '')} ‚Ä¢ ${escapeHtml(t.type)}</div></div><div style="display:flex;flex-direction:column;gap:6px"><button class="btn btn-primary" onclick="openTaskModal('${t.id}')">‚úèÔ∏è</button><button class="btn btn-outline" onclick="toggleTaskDone('${t.id}')">${t.done? '‚Ü∫' : '‚úì'}</button></div></div>`).join(''); }
function renderRecentLeads(){ const rec = leads.slice(-5).reverse(); const c = el('recentLeads'); if (!rec.length){ c.innerHTML = `<div class="small-note">No leads yet</div>`; return; } c.innerHTML = rec.map(l=> `<div style="padding:10px;border-radius:8px;border:1px solid #f1f6fb;margin-bottom:8px"><strong>${escapeHtml(l.name)}</strong><div class="small-note">${escapeHtml(l.phone)} ${l.from ? ' ‚Ä¢ '+escapeHtml(l.from): ''}</div></div>`).join(''); }

function wireFilters(){
  qAll('#propFilters .filter').forEach(btn=>{ btn.addEventListener('click', ()=> { qAll('#propFilters .filter').forEach(b=> b.classList.remove('active')); btn.classList.add('active'); renderProps(); }); });
  qAll('#leadFilters .filter').forEach(btn=>{ btn.addEventListener('click', ()=> { qAll('#leadFilters .filter').forEach(b=> b.classList.remove('active')); btn.classList.add('active'); renderLeads(); }); });
  qAll('#leadStatusFilters .filter').forEach(btn=>{ btn.addEventListener('click', ()=> { qAll('#leadStatusFilters .filter').forEach(b=> b.classList.remove('active')); btn.classList.add('active'); renderLeads(); }); });
  qAll('#taskFilters .filter').forEach(btn=>{ btn.addEventListener('click', ()=> { qAll('#taskFilters .filter').forEach(b=> b.classList.remove('active')); btn.classList.add('active'); renderTasks(); }); });
}

/* Property rendering (unchanged) */
function renderProps(){
  const container = el('propListContainer');
  const search = (el('propSearch').value || '').toLowerCase();
  const active = document.querySelector('#propFilters .filter.active');
  const propFilter = active ? active.dataset.type : '';
  const list = props.filter(p=>{ if (propFilter && propFilter !== '' && p.type !== propFilter) return false; if (!search) return true; return (p.title||'').toLowerCase().includes(search) || (p.loc||'').toLowerCase().includes(search) || (p.oName||'').toLowerCase().includes(search); });
  if (list.length === 0){ container.innerHTML = `<div class="card"><div class="small-note">No properties. Tap + to add one.</div></div>`; return; }
  const groups = {}; list.forEach(p => { (groups[p.type] = groups[p.type] || []).push(p); });
  let html = '';
  ['plot','villa','apartment','rental'].forEach(type => { if (!groups[type] || groups[type].length === 0) return; const label = ({plot:'üå≥ Plot',villa:'üè° Villa',apartment:'üè¢ Apartment',rental:'üîë Rental'})[type] || type; html += `<div class="card"><strong>${label} (${groups[type].length})</strong><div style="margin-top:10px">`; groups[type].sort((a,b)=> b.created.localeCompare(a.created)).forEach(p=>{ const img = (p.photos && p.photos[0]) ? `<img src="${p.photos[0]}" />` : `<div style="font-size:24px;opacity:0.5">üì∑</div>`; html += `<div class="property-card" style="margin-bottom:10px" onclick="viewProperty('${p.id}')"><div class="property-image">${img}</div><div class="property-info"><div class="property-title">${escapeHtml(p.title)}</div><div style="font-size:13px;color:${p.loc ? '#111' : '#666'}">üìç ${escapeHtml(p.loc || '‚Äî')}</div><div class="property-meta">${p.area ? `<span>üìê ${escapeHtml(p.area)}</span>` : ''}${p.beds ? `<span>üõè ${escapeHtml(p.beds)} BHK</span>` : ''}${p.price ? `<span>üí∞ ${escapeHtml(p.price)}</span>` : ''}</div><div class="owner">üë§ ${escapeHtml(p.oName)} ‚Ä¢ üìû ${escapeHtml(p.oPhone)}</div></div></div>`; }); html += '</div></div>'; });
  container.innerHTML = html;
}

/* viewProperty unchanged */
function viewProperty(id){
  const p = props.find(x=> x.id===id);
  if (!p) return;
  el('viewTitle').innerText = p.title || 'Property';
  let html = '';
  if (p.photos && p.photos.length){
    html += `<div style="display:flex;gap:8px;overflow:auto;margin-bottom:12px">` + p.photos.map(ph=>`<img src="${ph}" style="height:120px;border-radius:10px;object-fit:cover" />`).join('') + `</div>`;
  }
  html += `<div style="display:flex;justify-content:space-between;align-items:center"><strong style="font-size:18px">${escapeHtml(p.title)}</strong><div style="font-size:14px;color:var(--muted)">Type: ${escapeHtml(p.type)}</div></div>`;
  html += `<div style="margin-top:8px;color:var(--muted)">üìç ${escapeHtml(p.loc)}</div>`;
  html += `<div style="margin-top:8px;font-weight:700">üí∞ ${escapeHtml(p.price)}</div>`;
  if (p.type === 'plot'){ html += `<div style="margin-top:10px"><strong>Plot Details</strong><div class="small-note">Area: ${escapeHtml(p.plotArea||p.area||'‚Äî')}, Price/sqmt: ${escapeHtml(p.plotPricePer||'‚Äî')}</div><div class="small-note">Zoning: ${escapeHtml(p.plotZoning||'‚Äî')} ‚Ä¢ Title: ${escapeHtml(p.plotTitle||'‚Äî')}</div></div>`; }
  else if (p.type === 'apartment' || p.type === 'villa'){ html += `<div style="margin-top:10px"><strong>Area Details</strong><div class="small-note">Carpet: ${escapeHtml(p.carpetArea||'‚Äî')} ‚Ä¢ Built-up: ${escapeHtml(p.builtArea||'‚Äî')} ‚Ä¢ Super: ${escapeHtml(p.superArea||'‚Äî')}</div></div>`; }
  else if (p.type === 'rental'){ html += `<div style="margin-top:10px"><strong>Rental</strong><div class="small-note">${escapeHtml(p.rentalType||'‚Äî')} ‚Ä¢ ${escapeHtml(p.rentalPrice||'‚Äî')}</div></div>`; }
  if (p.geo) html += `<div style="margin-top:10px"><a class="btn btn-outline" href="${escapeHtml(p.geo)}" target="_blank">üìç Open in Google Maps</a></div>`;
  html += `<div style="margin-top:12px"><strong>Share Text</strong><div style="background:#fff8e6;padding:10px;border-radius:10px;margin-top:6px;white-space:pre-wrap">${escapeHtml(p.desc)}</div></div>`;
  html += `<div style="margin-top:12px"><strong>Owner (private)</strong><div class="small-note">Name: ${escapeHtml(p.oName)} ‚Ä¢ Phone: ${escapeHtml(p.oPhone)}</div>${p.oNotes?`<div class="small-note" style="margin-top:6px">${escapeHtml(p.oNotes)}</div>`:''}</div>`;
  html += `<div style="margin-top:12px;display:flex;gap:8px"><button class="btn btn-primary" onclick="shareProp('${p.id}')">üì§ Share</button><button class="btn btn-outline" onclick="editProperty('${p.id}')">‚úèÔ∏è Edit</button><button class="btn btn-danger" onclick="deleteProperty('${p.id}')">üóëÔ∏è Delete</button></div>`;
  el('viewBody').innerHTML = html; el('viewModal').classList.add('show');
}
function closeView(){ el('viewModal').classList.remove('show'); }
function editProperty(id){ closeView(); openPropModal(id); }
function deleteProperty(id){ if (!confirm('Delete property permanently?')) return; props = props.filter(p => p.id !== id); saveAll(); refreshUI(); }

/* small escape helper */
function escapeHtml(s){ if (!s && s !== 0) return ''; return String(s).replace(/[&<>"'`]/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'})[m]; }); }

/* initial render */
function refreshUIOnce(){ refreshUI(); }
refreshUIOnce();

</script>
</body>
</html>
